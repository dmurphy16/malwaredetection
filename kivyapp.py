import kivy
import os
from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.gridlayout import GridLayout
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.core.window import Window
from kivy.uix.gridlayout import GridLayout
from kivy.uix.popup import Popup
from kivy.uix.scrollview import ScrollView
from kivy.app import runTouchApp
from kivy.properties import StringProperty
from kivy.lang import Builder
from kivy.uix.boxlayout import BoxLayout


class MyPopup(Popup):
    def __init__(self, input, **kwargs):
        super().__init__(**kwargs)
        self.size_hint = (0.7, 0.7)
        self.title = "Malware Detection Results"
        # halign and valign acting weird -- FIX later!!
        label = Label(text=input,
                      size_hint_y=None, height=ScrollView().height, valign='center', halign='center')
        scrollview = ScrollView()
        scrollview.add_widget(label)
        self.content = BoxLayout(orientation="vertical")
        self.content.add_widget(scrollview)
        close_button = Button(text="Close", size_hint=(1, 0.2))
        close_button.bind(on_press=self.dismiss)
        self.content.add_widget(close_button)


class MyGridLayout(GridLayout):
    # Initialize infinite keywords
    def __init__(self, **kwargs):
        # Call grid layout constructor
        super(MyGridLayout, self).__init__(**kwargs)

        self.cols = 1
        self.inside = GridLayout()
        self.inside.cols = 2

        Window.clearcolor = (142/255, 157/255, 204/255)

        # Add widgets
        self.inside.add_widget(Label(
            text="Source Input (file, folder, URL): ", font_size=30, bold=True, color=(0, 0, 0)))
        # Add Input Box
        self.input = TextInput(multiline=True, font_size=30,
                               background_color=(217/255, 219/255, 241/255))
        self.inside.add_widget(self.input)

        self.inside.add_widget(Label(
            text="Zip Archive Password (if applicable): ", font_size=30, bold=True, color=(0, 0, 0)))
        # Add Input Box
        self.zippass = TextInput(
            multiline=False, font_size=30, background_color=(217/255, 219/255, 241/255))
        self.inside.add_widget(self.zippass)

        self.add_widget(self.inside)

        # Create a Scan Button
        self.scan = Button(
            text="Scan",
            font_size=32,
            background_color=(203/255, 247/255, 237/255),
            size_hint=(0.25, 0.25))
        # Bind the button
        self.scan.bind(on_press=self.press)
        self.add_widget(self.scan)

    def press(self, instance):
        input = self.input.text
        zippass = self.zippass.text

        cmd = 'python3 run.py run ' + input
        if len(zippass) > 0:
            cmd = cmd + ' --password ' + zippass
        cmd = cmd + ' -l quiet'

        output = os.popen(cmd).read()

        popup = MyPopup(output)
        popup.open()

        # Clear the input boxes
        self.input.text = ""
        self.zippass.text = ""


class MalwareDetection(App):
    def build(self):
        return MyGridLayout()


if __name__ == '__main__':
    MalwareDetection().run()
