import argparse
import subprocess

# Creates and runs a Docker image to analyze malware
MODES = ["build", "run"]
IMAGE_NAME = "malwarescanner"


def main():
    parser = argparse.ArgumentParser(prog="Malware Scanner Runner",
                                     description="Creates and runs a Docker image to analyze malware")
    parser.add_argument('mode', type=str, help='The mode of operation (one of ' + str(MODES) + ')')
    parser.add_argument('filename', type=str, help="The file path or URL for the malware sample")
    # other args: password (if the malware is in a zip archive), directory, custom rules, logging and debug levels

    args = parser.parse_args()

    if args.mode not in MODES:
        print("Error! " + str(args.mode) + " not a valid mode")

    elif args.mode == "build":  # build the Docker image
        result = subprocess.run(["docker", "build", "-t", IMAGE_NAME, "."],
                                capture_output=True, text=True)

                                # check=True, stdout=subprocess.PIPE, shell=True)
        print(result.stdout)
        print(result.stderr)

    elif args.mode == "run":    # runs the image
        result = subprocess.run(["docker", "run", "-it", "--rm", "--name=scanner", IMAGE_NAME, args.filename],
                                capture_output=True, text=True)
        print(result.stdout)
        print(result.stderr)
        # check=True, stdout=subprocess.PIPE, shell=True)
    else:
        print("Error! This shouldn't happen")


if __name__ == "__main__":
    main()
